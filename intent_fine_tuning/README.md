# æ„å›¾è¯†åˆ«å¾®è°ƒ

åŸºäº m3e-small çš„è½»é‡çº§æ„å›¾åˆ†ç±»å™¨ï¼Œç”¨äºè¯†åˆ«ç”¨æˆ·æŸ¥è¯¢çš„æ„å›¾ï¼Œä¼˜åŒ–RAGç³»ç»Ÿçš„æ£€ç´¢ç­–ç•¥ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

- **è½»é‡çº§**: åŸºäºç°æœ‰çš„ m3e-small æ¨¡å‹ï¼Œåªéœ€è®­ç»ƒå°çš„åˆ†ç±»å¤´
- **å¤šè¯­è¨€**: æ”¯æŒä¸­è‹±æ–‡æ··åˆæŸ¥è¯¢
- **é«˜å‡†ç¡®ç‡**: åœ¨ç®€å•ä»»åŠ¡ä¸Šè¾¾åˆ°è¾ƒé«˜çš„åˆ†ç±»å‡†ç¡®ç‡
- **å¯é…ç½®**: æ”¯æŒè‡ªå®šä¹‰æ„å›¾ç±»åˆ«å’Œå“åº”ç­–ç•¥

## ğŸ“‹ æ„å›¾ç±»åˆ«

| ç±»åˆ« | è¯´æ˜ | ç¤ºä¾‹ | RAGç­–ç•¥ |
|------|------|------|---------|
| `greeting` | é—®å€™/è‡ªæˆ‘ä»‹ç» | "ä½ å¥½", "ä½ æ˜¯è°", "ä½ èƒ½åšä»€ä¹ˆ" | è·³è¿‡RAGï¼Œç›´æ¥å›å¤ |
| `politeness` | ç¤¼è²Œç”¨è¯­ | "è°¢è°¢", "å†è§", "ä¸å®¢æ°”" | è·³è¿‡RAGï¼Œç›´æ¥å›å¤ |
| `system` | ç³»ç»ŸæŸ¥è¯¢ | "ç³»ç»Ÿæç¤ºè¯", "ä»€ä¹ˆæ¨¡å‹", "æŠ€æœ¯æ ˆ" | è·³è¿‡RAGï¼Œå®‰å…¨å›å¤ |
| `chitchat` | é—²èŠ | "ç°åœ¨å‡ ç‚¹", "å¤©æ°”æ€ä¹ˆæ ·", "è®²ä¸ªç¬‘è¯" | è·³è¿‡RAGï¼Œå‹å¥½æ‹’ç» |
| `knowledge` | çŸ¥è¯†é—®ç­” | "ç‹—ç‹—éœ€è¦æ¯å¤©é›å—", "å¦‚ä½•è®­ç»ƒç‹—ç‹—" | æ­£å¸¸RAGæµç¨‹ |
| `unknown` | æœªçŸ¥/å…¶ä»– | "å—¯", "å•Š", "å“¦" | é»˜è®¤RAGæµç¨‹ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. è®­ç»ƒæ¨¡å‹

```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°è®­ç»ƒ
python train.py

# è‡ªå®šä¹‰å‚æ•°
python train.py --model_path ../model/moka-ai/m3e-small --save_dir ./models/intent-classifier --test_size 0.2
```

### 3. å¤åˆ¶æ¨¡å‹åˆ°ä¸»ç›®å½•

è®­ç»ƒå®Œæˆåï¼Œéœ€è¦å°†æ¨¡å‹å¤åˆ¶åˆ°ä¸»é¡¹ç›®çš„æ¨¡å‹ç›®å½•æ‰èƒ½ä½¿ç”¨

### 4. æµ‹è¯•æ¨¡å‹

```bash
# æµ‹è¯•æ‰€æœ‰é¢„è®¾ç”¨ä¾‹
python test.py

# æµ‹è¯•ç‰¹å®šæ–‡æœ¬
python test.py --text "ä½ å¥½"
```

### 5. åœ¨ä»£ç ä¸­ä½¿ç”¨

```python
from intent_classifier import IntentClassifier

# åˆ›å»ºåˆ†ç±»å™¨
classifier = IntentClassifier(model_path="../model/moka-ai/m3e-small")

# åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹
classifier.load_model("./models/intent-classifier")

# åˆ†ç±»
result = classifier.classify("ä½ å¥½")
print(result)
# è¾“å‡º: {
#   "intent": "greeting",
#   "confidence": 0.95,
#   "skip_rag": True,
#   "response": "ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½é—®ç­”åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ"
# }
```

## ğŸ“¦ æ•°æ®ç»“æ„

è®­ç»ƒæ•°æ®æ‹†åˆ†ä¸ºä¸¤ä¸ªæ–‡ä»¶ï¼Œä¾¿äºä¸åŒé¢†åŸŸé¡¹ç›®å¤ç”¨ï¼š

### `training_data_general.json` - é€šç”¨æ•°æ®ï¼ˆ120æ¡ï¼‰
åŒ…å«ä¸é¢†åŸŸæ— å…³çš„é€šç”¨æ„å›¾æ•°æ®ï¼š
- `greeting`: é—®å€™ã€è‡ªæˆ‘ä»‹ç»ï¼ˆ29æ¡ï¼‰
- `politeness`: ç¤¼è²Œç”¨è¯­ï¼ˆ16æ¡ï¼‰
- `system`: ç³»ç»ŸæŸ¥è¯¢ï¼ˆ21æ¡ï¼‰
- `chitchat`: é—²èŠï¼ˆ35æ¡ï¼‰ - **æ–°å¢**
- `unknown`: æœªçŸ¥/å…¶ä»–ï¼ˆ19æ¡ï¼‰

**ç‰¹ç‚¹**ï¼šå¯ç›´æ¥å¤ç”¨åˆ°å…¶ä»–é¡¹ç›®ï¼Œæ— éœ€ä¿®æ”¹

### `training_data_domain.json` - é¢†åŸŸæ•°æ®ï¼ˆ50æ¡ï¼‰
åŒ…å«ç‰¹å®šé¢†åŸŸçš„çŸ¥è¯†é—®ç­”æ•°æ®ï¼š
- `knowledge`: çŸ¥è¯†é—®ç­”ï¼ˆ50æ¡ï¼Œæ ¹æ®å®é™…é¢†åŸŸä¿®æ”¹ï¼‰

**ç‰¹ç‚¹**ï¼šæ ¹æ®ä¸åŒé¡¹ç›®éœ€æ±‚ï¼Œåªéœ€æ›¿æ¢æ­¤æ–‡ä»¶

### å¦‚ä½•é€‚é…æ–°é¢†åŸŸï¼Ÿ

1. **ä¿ç•™** `training_data_general.json`ï¼ˆé€šç”¨æ•°æ®ä¸å˜ï¼‰
2. **ä¿®æ”¹** `training_data_domain.json`ï¼š
   ```json
   {
       "knowledge": [
           "ä½ çš„é¢†åŸŸé—®é¢˜1",
           "ä½ çš„é¢†åŸŸé—®é¢˜2",
           "ä½ çš„é¢†åŸŸé—®é¢˜3",
           ...
       ]
   }
   ```
3. **é‡æ–°è®­ç»ƒ**ï¼š`python train.py`

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **è®­ç»ƒæ•°æ®**: ~170æ¡æ ‡æ³¨æ ·æœ¬ï¼ˆé€šç”¨120æ¡ + é¢†åŸŸ50æ¡ï¼‰
- **æ„å›¾ç±»åˆ«**: 6ç±»ï¼ˆgreeting, politeness, system, chitchat, knowledge, unknownï¼‰
- **ç‰¹å¾ç»´åº¦**: 512 (m3e-smallè¾“å‡º)
- **åˆ†ç±»å™¨**: LogisticRegression
- **é¢„æœŸå‡†ç¡®ç‡**: >90% (åœ¨ç®€å•åœºæ™¯ä¸‹)
- **è®­ç»ƒè¿›åº¦**: æ”¯æŒtqdmè¿›åº¦æ¡æ˜¾ç¤º

## ğŸ“‚ æ¨¡å‹è·¯å¾„è¯´æ˜

### é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„
- **m3e-small**: `../model/moka-ai/m3e-small/` (é¢„è®­ç»ƒçš„embeddingæ¨¡å‹)
- **ç”¨é€”**: æ–‡æœ¬å‘é‡åŒ–ï¼Œå°†æ–‡æœ¬è½¬æ¢ä¸º768ç»´å‘é‡

### å¾®è°ƒæ¨¡å‹è·¯å¾„
- **è®­ç»ƒè¾“å‡º**: `./models/intent-classifier/` (è®­ç»ƒè„šæœ¬çš„è¾“å‡ºç›®å½•)
- **å®é™…ä½¿ç”¨**: `../model/intent-classifier/` (ä¸»é¡¹ç›®çš„æ¨¡å‹ç›®å½•)
- **åŒ…å«æ–‡ä»¶**:
  - `intent_classifier.pkl`: è®­ç»ƒå¥½çš„LogisticRegressionåˆ†ç±»å™¨
  - `label_encoder.json`: æ ‡ç­¾ç¼–ç å’Œé…ç½®ä¿¡æ¯
- **ç”¨é€”**: æ„å›¾åˆ†ç±»ï¼Œåˆ¤æ–­ç”¨æˆ·è¾“å…¥çš„æ„å›¾ç±»åˆ«
- **æ³¨æ„**: è®­ç»ƒåéœ€è¦æ‰‹åŠ¨å¤åˆ¶åˆ°ä¸»é¡¹ç›®ç›®å½•æ‰èƒ½ä½¿ç”¨

## ğŸ”§ é…ç½®è¯´æ˜

### æ„å›¾é…ç½®

å¯ä»¥åœ¨ `intent_classifier.py` ä¸­ä¿®æ”¹ `intent_config`:

```python
self.intent_config = {
    "greeting": {
        "skip_rag": True,
        "response": "ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½é—®ç­”åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ"
    },
    "knowledge": {
        "skip_rag": False,
        "response": None  # æ­£å¸¸RAGæµç¨‹
    }
    # ... å…¶ä»–é…ç½®
}
```

### æ·»åŠ æ–°çš„æ„å›¾ç±»åˆ«

1. åœ¨ `intent_classes` ä¸­æ·»åŠ æ–°ç±»åˆ«
2. åœ¨ `intent_config` ä¸­æ·»åŠ é…ç½®
3. åœ¨ `training_data.json` ä¸­æ·»åŠ è®­ç»ƒæ ·æœ¬
4. é‡æ–°è®­ç»ƒæ¨¡å‹

## ğŸ“ æ–‡ä»¶ç»“æ„

```
intent_fine_tuning/
â”œâ”€â”€ intent_classifier.py          # ä¸»åˆ†ç±»å™¨ä»£ç 
â”œâ”€â”€ train.py                     # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ test.py                      # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ training_data_general.json   # é€šç”¨è®­ç»ƒæ•°æ®ï¼ˆå¯å¤ç”¨ï¼‰
â”œâ”€â”€ training_data_domain.json    # é¢†åŸŸè®­ç»ƒæ•°æ®ï¼ˆéœ€ä¿®æ”¹ï¼‰
â”œâ”€â”€ test_data.json               # æµ‹è¯•æ•°æ®æ–‡ä»¶
â”œâ”€â”€ requirements.txt             # ä¾èµ–åŒ…
â”œâ”€â”€ README.md                   # è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ æ„å›¾è¯†åˆ«é›†æˆæŒ‡å—.md          # é›†æˆæŒ‡å—
â””â”€â”€ models/intent-classifier/    # è®­ç»ƒå¥½çš„æ¨¡å‹ (è®­ç»ƒåç”Ÿæˆ)
    â”œâ”€â”€ intent_classifier.pkl
    â””â”€â”€ label_encoder.json

# ä½¿ç”¨æ—¶éœ€è¦å¤åˆ¶åˆ°ä¸»é¡¹ç›®ç›®å½•
../model/intent-classifier/      # ä¸»é¡¹ç›®çš„æ¨¡å‹ç›®å½•
    â”œâ”€â”€ intent_classifier.pkl
    â””â”€â”€ label_encoder.json
```

### ğŸ“Š æ•°æ®æ–‡ä»¶è¯´æ˜

#### `training_data_general.json` - é€šç”¨æ•°æ®
åŒ…å«ä¸é¢†åŸŸæ— å…³çš„é€šç”¨æ„å›¾æ•°æ®ï¼š
```json
{
  "greeting": ["ä½ å¥½", "hello", "ä½ æ˜¯è°", "ä½ èƒ½åšä»€ä¹ˆ", ...],
  "politeness": ["è°¢è°¢", "æ„Ÿè°¢", "å†è§", "ä¸å®¢æ°”", ...],
  "system": ["ç³»ç»Ÿæç¤ºè¯", "æ¨¡å‹ä¿¡æ¯", "æŠ€æœ¯æ ˆ", ...],
  "chitchat": ["ç°åœ¨å‡ ç‚¹", "å¤©æ°”æ€ä¹ˆæ ·", "è®²ä¸ªç¬‘è¯", ...],
  "unknown": ["å—¯", "å•Š", "è¿™ä¸ª", ...]
}
```

#### `training_data_domain.json` - é¢†åŸŸæ•°æ®
åŒ…å«ç‰¹å®šé¢†åŸŸçš„çŸ¥è¯†é—®ç­”æ•°æ®ï¼ˆæ ¹æ®é¡¹ç›®ä¿®æ”¹ï¼‰ï¼š
```json
{
  "knowledge": [
    "ç‹—ç‹—éœ€è¦æ¯å¤©é›å—",
    "å¦‚ä½•è®­ç»ƒç‹—ç‹—",
    "ç‹—ç‹—å¯ä»¥åƒä»€ä¹ˆ",
    ...
  ]
}
```

#### `test_data.json`
åŒ…å«ç»“æ„åŒ–çš„æµ‹è¯•ç”¨ä¾‹ï¼š
```json
{
  "test_cases": [
    {
      "text": "ä½ å¥½",
      "expected_intent": "greeting",
      "description": "ç®€å•é—®å€™"
    }
  ],
  "edge_cases": [...],
  "mixed_language": [...]
}
```

## ğŸ›ï¸ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰è®­ç»ƒæ•°æ®

#### ä¿®æ”¹é€šç”¨æ•°æ®ï¼ˆè°¨æ…ï¼‰
ç¼–è¾‘ `training_data_general.json`ï¼Œæ·»åŠ æ›´å¤šé€šç”¨æ ·æœ¬ï¼š

```json
{
  "greeting": [
    "ä½ å¥½",
    "hello",
    "æ–°çš„é—®å€™è¯­"  // æ·»åŠ æ–°çš„é€šç”¨é—®å€™
  ],
  "chitchat": [
    "ç°åœ¨å‡ ç‚¹",
    "æ–°çš„é—²èŠé—®é¢˜"  // æ·»åŠ æ–°çš„é—²èŠæ ·æœ¬
  ]
}
```

#### ä¿®æ”¹é¢†åŸŸæ•°æ®ï¼ˆæ¨èï¼‰
ç¼–è¾‘ `training_data_domain.json`ï¼Œæ›¿æ¢ä¸ºä½ çš„é¢†åŸŸæ•°æ®ï¼š

```json
{
  "knowledge": [
    "ä½ çš„é¢†åŸŸé—®é¢˜1",
    "ä½ çš„é¢†åŸŸé—®é¢˜2",
    "ä½ çš„é¢†åŸŸé—®é¢˜3"
    // æ·»åŠ æ›´å¤šé¢†åŸŸç›¸å…³çš„é—®é¢˜
  ]
}
```

### è‡ªå®šä¹‰æµ‹è¯•æ•°æ®

ç¼–è¾‘ `test_data.json` æ–‡ä»¶ï¼Œæ·»åŠ æµ‹è¯•ç”¨ä¾‹ï¼š

```json
{
  "test_cases": [
    {
      "text": "æ–°çš„æµ‹è¯•æ–‡æœ¬",
      "expected_intent": "greeting",
      "description": "æµ‹è¯•æè¿°"
    }
  ]
}
```

### è°ƒæ•´åˆ†ç±»å™¨å‚æ•°

åœ¨ `train_classifier()` æ–¹æ³•ä¸­ä¿®æ”¹åˆ†ç±»å™¨å‚æ•°ï¼š

```python
self.classifier = LogisticRegression(
    random_state=42,
    max_iter=1000,
    C=1.0,  # æ­£åˆ™åŒ–å¼ºåº¦
    multi_class='ovr'
)
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ¨¡å‹è·¯å¾„é”™è¯¯**
   ```
   FileNotFoundError: [Errno 2] No such file or directory
   ```
   è§£å†³ï¼šæ£€æŸ¥ `model_path` å‚æ•°æ˜¯å¦æ­£ç¡®æŒ‡å‘ m3e-small æ¨¡å‹

2. **KeyError: np.int64(x)**
   ```
   KeyError: np.int64(4)
   ```
   è§£å†³ï¼šæ¨¡å‹æ ¼å¼å·²æ›´æ–°ï¼Œè¯·é‡æ–°è®­ç»ƒæ¨¡å‹ï¼š`python train.py`

3. **è®­ç»ƒæ•°æ®æ–‡ä»¶æœªæ‰¾åˆ°**
   ```
   è®­ç»ƒæ•°æ®æ–‡ä»¶ training_data.json ä¸å­˜åœ¨
   ```
   è§£å†³ï¼šç¡®ä¿ `training_data.json` æ–‡ä»¶å­˜åœ¨äºå½“å‰ç›®å½•

4. **å†…å­˜ä¸è¶³**
   ```
   RuntimeError: CUDA out of memory
   ```
   è§£å†³ï¼šm3e-small æ¨¡å‹è¾ƒå°ï¼Œé€šå¸¸CPUå³å¯è¿è¡Œï¼Œå¦‚é‡å†…å­˜é—®é¢˜å¯å‡å°‘æ‰¹å¤„ç†å¤§å°

5. **å‡†ç¡®ç‡è¾ƒä½**
   - å¢åŠ è®­ç»ƒæ•°æ®æ ·æœ¬
   - è°ƒæ•´åˆ†ç±»å™¨å‚æ•°
   - æ£€æŸ¥è®­ç»ƒæ•°æ®è´¨é‡
