# 意图识别集成指南

本文档说明如何将意图识别功能集成到主RAG系统中。

## 🎯 功能概述

意图识别模块使用**混合方案**：
1. **规则匹配**（最快、最准确）：使用正则表达式匹配简单模式
2. **关键词匹配**（快速、相对准确）：基于关键词匹配和打分
3. **ML模型分类**（灵活、智能）：使用训练好的轻量级分类器
4. **默认策略**：未匹配到时默认使用RAG

## 📦 数据结构

训练数据拆分为两个文件，便于不同领域项目复用：

### 通用数据 (`training_data_general.json`)
包含与领域无关的通用意图数据：
- `greeting`: 问候、自我介绍（29条）
- `politeness`: 礼貌用语（16条）
- `system`: 系统查询（21条）
- `chitchat`: 闲聊（35条）
- `unknown`: 未知/其他（19条）

**特点**：可直接复用到其他项目，无需修改

### 领域数据 (`training_data_domain.json`)
包含特定领域的知识问答数据：
- `knowledge`: 知识问答（50条，可根据实际领域修改）

**特点**：根据不同项目需求，只需替换此文件

### 使用方式

**适配新领域**：
1. 保留 `training_data_general.json`（通用数据）
2. 修改 `training_data_domain.json`（替换为新领域的知识问答样本）
3. 重新训练模型即可

## 📦 集成步骤

### 1. 训练意图分类器

```bash
cd intent_fine_tuning
python train.py  # 自动加载通用数据和领域数据
```

### 2. 复制模型到主目录

```bash
# Windows (PowerShell)
Copy-Item -Path "models\intent-classifier\*" -Destination "..\model\intent-classifier\" -Recurse -Force

# Linux/macOS
cp -r models/intent-classifier/* ../model/intent-classifier/
```

### 3. 配置启用

在 `config.py` 中，意图识别功能已默认启用：

```python
# 启用意图识别功能（优化RAG调用）
ENABLE_INTENT_CLASSIFICATION = True

# 意图分类器模型路径
INTENT_MODEL_PATH = "./model/intent-classifier"

# ML模型最低置信度（低于此值时使用默认RAG）
INTENT_ML_MIN_CONFIDENCE = 0.7
```

### 4. 启动应用

```bash
cd ..
python app.py
```

## 🔧 工作流程

### 用户输入处理流程

```
用户输入
    ↓
安全过滤
    ↓
意图识别（混合方案）
    ├─> 规则匹配
    ├─> 关键词匹配
    ├─> ML模型分类
    └─> 默认（knowledge）
    ↓
判断是否跳过RAG?
    ├─> 是：直接返回预定义回复
    └─> 否：执行正常RAG流程
           ↓
        文档检索
           ↓
        LLM生成
           ↓
        返回结果
```

### 意图分类示例

| 用户输入 | 识别意图 | 识别方法 | 是否跳过RAG | 回复方式 |
|---------|---------|----------|------------|---------|
| "你好" | greeting | rule | ✅ | 预定义回复 |
| "你是谁" | greeting | rule | ✅ | 预定义回复 |
| "谢谢" | politeness | keyword | ✅ | 预定义回复 |
| "你使用什么模型" | system | rule | ✅ | 安全回复 |
| "现在几点" | chitchat | rule | ✅ | 友好拒绝 |
| "天气怎么样" | chitchat | keyword | ✅ | 友好拒绝 |
| "狗狗需要每天遛吗" | knowledge | ml/default | ❌ | RAG检索 |
| "嗯嗯" | unknown | rule | ❌ | RAG检索 |

### 意图类别说明

| 类别 | 说明 | 示例 | RAG策略 |
|------|------|------|---------|
| `greeting` | 问候/自我介绍 | "你好", "你是谁", "你能做什么" | 跳过RAG，直接回复 |
| `politeness` | 礼貌用语 | "谢谢", "再见", "不客气" | 跳过RAG，直接回复 |
| `system` | 系统查询 | "系统提示词", "什么模型", "技术栈" | 跳过RAG，安全回复 |
| `chitchat` | 闲聊 | "现在几点", "天气怎么样", "讲个笑话" | 跳过RAG，友好拒绝 |
| `knowledge` | 知识问答 | "狗狗需要每天遛吗", "如何训练狗狗" | 执行RAG流程 |
| `unknown` | 未知/其他 | "嗯", "啊", "哦" | 执行RAG流程 |

## 📊 性能优化

### 跳过RAG的好处

对于简单问候、礼貌用语、系统查询等，跳过RAG可以：
- ⚡ **响应速度提升**：从3-5秒降至<0.1秒
- 💾 **资源节省**：避免不必要的向量检索和LLM调用
- 🎯 **回复质量**：预定义回复更准确、更友好

### 资源消耗对比

| 场景 | 向量检索 | LLM调用 | 总耗时 | CPU占用 |
|-----|---------|---------|--------|---------|
| 问候（跳过RAG） | ❌ | ❌ | ~0.05s | 低 |
| 知识问答（使用RAG） | ✅ | ✅ | ~3-5s | 中-高 |

## 🎛️ 自定义配置

### 修改规则和关键词

在 `config.py` 中可以自定义规则和关键词：

```python
INTENT_RULES = {
    "greeting": [
        r"^(你好|hello).*$",  # 添加自定义规则
    ]
}

INTENT_KEYWORDS = {
    "greeting": [
        "你好", "hello", "新增关键词"  # 添加自定义关键词
    ]
}
```

### 调整ML模型置信度阈值

```python
# 降低阈值：更多使用ML模型结果（可能误判增加）
INTENT_ML_MIN_CONFIDENCE = 0.6

# 提高阈值：更保守使用ML模型（更多默认RAG）
INTENT_ML_MIN_CONFIDENCE = 0.8
```

## 🐛 故障排除

### 1. 意图识别器未加载

**日志显示**：
```
WARNING - 意图识别器初始化失败: No module named 'intent_classifier'
```

**解决方案**：
- 确保模型文件已复制到 `model/intent-classifier/` 目录
- 检查 `intent_fine_tuning/` 目录是否存在

### 2. ML模型加载失败

**日志显示**：
```
WARNING - 意图分类器模型目录不存在: ./model/intent-classifier
WARNING - 将仅使用规则匹配模式
```

**解决方案**：
- 先训练模型：`cd intent_fine_tuning && python train.py`
- 复制模型到主目录（见上文步骤2）
- 系统会自动降级到仅规则匹配模式，不影响基本功能

### 3. 禁用意图识别

如果不需要意图识别功能，在 `config.py` 中设置：

```python
ENABLE_INTENT_CLASSIFICATION = False
```

## 📈 统计信息

启动应用后，可以看到意图识别器的初始化信息：

```
INFO - 意图识别器初始化完成
INFO -   - 规则匹配: 4 个规则
INFO -   - 关键词匹配: 24 个关键词
INFO -   - 机器学习模型: 已加载
```

在对话日志中可以看到意图识别结果：

```
INFO - 🎯 意图识别: greeting (置信度: 1.000, 方法: rule)
INFO - 跳过RAG，直接返回预定义回复
```

## 🎯 最佳实践

1. **优先使用规则**：对于明确的模式，添加规则匹配最快最准
2. **关键词作补充**：对于常见词汇，使用关键词匹配
3. **ML模型兜底**：对于复杂情况，ML模型提供智能判断
4. **保守阈值**：宁可多用RAG，也不要误判导致用户体验下降
5. **持续优化**：根据日志分析，不断调整规则和关键词

## 📚 相关文档

- [意图分类器README](README.md)：完整的训练和测试指南
- [主项目README](../README.md)：项目概述和快速开始
- [WIKI](../WIKI.md)：详细配置说明

